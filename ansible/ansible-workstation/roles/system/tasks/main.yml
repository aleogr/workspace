- name: Configurar Reposit√≥rios (Debian & Proxmox No-Sub)
  ansible.builtin.copy:
    dest: "/etc/apt/sources.list.d/pve-no-subscription.sources"
    content: |
      Types: deb
      URIs: http://download.proxmox.com/debian/pve
      Suites: {{ debian_codename }}
      Components: pve-no-subscription
      Signed-By: /usr/share/keyrings/proxmox-release-{{ debian_codename }}.gpg
      
      Types: deb
      URIs: http://download.proxmox.com/debian/pbs
      Suites: {{ debian_codename }}
      Components: pbs-no-subscription
      Signed-By: /usr/share/keyrings/proxmox-release-{{ debian_codename }}.gpg

- name: Remover listas antigas para evitar conflitos
  ansible.builtin.file:
    path: "/etc/apt/sources.list.d/{{ item }}"
    state: absent
  loop:
    - pve-enterprise.list
    - ceph.list

- name: Atualizar Cache e Sistema
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
    autoremove: yes

- name: Instalar Pacotes Base
  ansible.builtin.apt:
    name: [intel-microcode, build-essential, pve-headers, vim, htop, btop, curl, git, ethtool, nvtop]
    state: present

- name: Remover Aviso de Assinatura (Nag Removal)
  ansible.builtin.replace:
    path: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
    regexp: "Ext.Msg.show\\(\\{\\s+title: gettext\\('No valid subscription'\\),"
    replace: "void({ //"
  notify: Restart PVEProxy
