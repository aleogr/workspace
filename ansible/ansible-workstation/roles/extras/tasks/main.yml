---
# --- TAREFA 1: SUPORTE MULTI-ARCH (Etapa 09 do script antigo) ---
- name: Instalar suporte a Multi-Arquitetura (LXC Only)
  ansible.builtin.apt:
    name:
      - qemu-user-static
      - binfmt-support
    state: present
    update_cache: yes

# --- TAREFA 2: PVESCRIPTS LOCAL (Etapa 08 do script antigo) ---
- name: Garantir arquivo de Timezone (Correção para o instalador)
  ansible.builtin.copy:
    content: "{{ lookup('pipe', 'timedatectl show --property=Timezone --value') }}\n"
    dest: /etc/timezone
    mode: '0644'

- name: Verificar se o Container PVEScriptsLocal já existe
  ansible.builtin.shell: pct list | grep -q "pve-scripts-local"
  register: container_check
  ignore_errors: true
  changed_when: false

- name: Instalar PVEScriptsLocal (Script da Comunidade)
  ansible.builtin.shell: |
    bash -c "$(curl -fsSL https://raw.githubusercontent.com/community-scripts/ProxmoxVE/main/ct/pve-scripts-local.sh)"
  args:
    executable: /bin/bash
  when: container_check.rc != 0
  register: install_result

# --- TAREFA 3: ATUALIZAR KIOSK COM A NOVA URL ---
- name: Obter ID do Container PVEScriptsLocal
  ansible.builtin.shell: pct list | grep "pve-scripts-local" | awk '{print $1}'
  register: container_id
  changed_when: false
  when: container_check.rc == 0 or install_result.changed

- name: Obter IP do Container PVEScriptsLocal
  ansible.builtin.shell: |
    pct exec {{ container_id.stdout }} -- ip -4 -br addr show eth0 | awk '{print $3}' | cut -d/ -f1
  register: container_ip
  changed_when: false
  when: container_id.stdout is defined and container_id.stdout != ""

- name: Adicionar URL do Scripts ao Kiosk Mode
  vars:
    kiosk_file: "/home/{{ new_user }}/.config/autostart/proxmox-ui.desktop"
    # Define a nova URL (Porta 3000)
    scripts_url: "http://{{ container_ip.stdout }}:3000"
  ansible.builtin.replace:
    path: "{{ kiosk_file }}"
    # Procura pela linha Exec e se certifica de que a URL não está lá antes de adicionar
    regexp: '(Exec=chromium.*https://localhost:8007)(.*)'
    replace: '\1 {{ scripts_url }}'
  when: 
    - container_ip.stdout is defined 
    - container_ip.stdout != ""
  notify: Restart LightDM
