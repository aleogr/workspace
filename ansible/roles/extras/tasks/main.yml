---
# --- TAREFA 1: SUPORTE MULTI-ARCH ---
- name: Instalar suporte a Multi-Arquitetura (LXC Only)
  ansible.builtin.apt:
    name:
      - qemu-user-static
      - binfmt-support
    state: present
    update_cache: yes

# --- TAREFA 2: PVESCRIPTS LOCAL ---
- name: Garantir arquivo de Timezone (Correção para instalador)
  ansible.builtin.copy:
    content: "{{ lookup('pipe', 'timedatectl show --property=Timezone --value') }}\n"
    dest: /etc/timezone
    mode: '0644'

- name: Verificar se o Container PVEScriptsLocal já existe
  ansible.builtin.shell: pct list | grep -q "pve-scripts-local"
  register: container_check
  # CORREÇÃO: Aceita 0 (Existe) e 1 (Não Existe) como sucesso
  failed_when: container_check.rc not in [0, 1]
  changed_when: false

- name: Instalar PVEScriptsLocal (Script da Comunidade)
  ansible.builtin.shell: |
    bash -c "$(curl -fsSL https://raw.githubusercontent.com/community-scripts/ProxmoxVE/main/ct/pve-scripts-local.sh)"
  args:
    executable: /bin/bash
  # Só roda se o grep retornou 1 (Não encontrou)
  when: container_check.rc == 1
  register: install_result

# --- TAREFA 3: ATUALIZAR KIOSK COM A NOVA URL ---
- name: Obter ID do Container PVEScriptsLocal
  ansible.builtin.shell: pct list | grep "pve-scripts-local" | awk '{print $1}'
  register: container_id
  changed_when: false
  # Executa se já existia (rc=0) ou se acabou de instalar (changed)
  when: container_check.rc == 0 or install_result.changed

- name: Obter IP do Container PVEScriptsLocal
  ansible.builtin.shell: |
    pct exec {{ container_id.stdout }} -- ip -4 -br addr show eth0 | awk '{print $3}' | cut -d/ -f1
  register: container_ip
  changed_when: false
  when: container_id.stdout is defined and container_id.stdout != ""

- name: Adicionar URL do Scripts ao Kiosk Mode
  vars:
    kiosk_file: "/home/{{ new_user }}/.config/autostart/proxmox-ui.desktop"
    scripts_url: "http://{{ container_ip.stdout }}:3000"
  ansible.builtin.replace:
    path: "{{ kiosk_file }}"
    # Regex ajustado para adicionar a URL apenas se ela não existir
    regexp: '(Exec=chromium.*https://localhost:8007)(?!.*{{ scripts_url }})(.*)'
    replace: '\1 {{ scripts_url }}\2'
  when: 
    - container_ip.stdout is defined 
    - container_ip.stdout != ""
  notify: Restart LightDM
