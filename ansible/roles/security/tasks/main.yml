---
# --- PARTE 1: DESBLOQUEIO DO ZFS NO BOOT ---
- name: Criar Serviço Systemd para Desbloqueio ZFS
  ansible.builtin.copy:
    dest: /etc/systemd/system/zfs-load-key.service
    mode: '0644'
    content: |
      [Unit]
      Description=Load ZFS encryption keys
      DefaultDependencies=no
      Before=zfs-mount.service
      After=zfs-import.target
      Requires=zfs-import.target

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/usr/sbin/zfs load-key -a
      StandardInput=tty-force

      [Install]
      WantedBy=zfs-mount.service
  notify: Enable Boot Unlock

# --- PARTE 2: HARDENING DO SISTEMA (PAM/SUDO) ---
- name: Instalar pacotes de segurança e autenticação
  ansible.builtin.apt:
    name:
      - sudo
      - libpam-u2f
      - libpam-pwquality
    state: present

- name: Configurar permissões de sudo para o usuário
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ new_user }}"
    content: "{{ new_user }} ALL=(ALL) ALL"
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Criar diretório de configuração Yubico
  ansible.builtin.file:
    path: /etc/Yubico
    state: directory
    mode: '0755'

- name: Criar arquivo de mapeamento U2F vazio (se não existir)
  ansible.builtin.file:
    path: /etc/Yubico/u2f_mappings
    state: touch
    mode: '0644'
    modification_time: preserve
    access_time: preserve

# --- PARTE 3: CONFIGURAÇÃO DO PAM ---
# Atenção: Estas alterações são sensíveis. Usamos lineinfile com cuidado.

- name: Configurar PAM U2F (Auth) - Permitir login com Chave
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-auth
    line: "auth sufficient pam_u2f.so cue nouserok authfile=/etc/Yubico/u2f_mappings"
    insertbefore: BOF # Insere no topo do arquivo
    state: present

- name: Configurar PAM Password Quality (Senhas Fortes)
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-password
    line: "password requisite pam_pwquality.so retry=3 minlen=12 difok=4 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1 enforce_for_root"
    insertbefore: BOF
    state: present

# --- PARTE 4: INSTRUÇÃO MANUAL ---
# Como o Ansible roda não-interativo, não podemos pedir para tocar na YubiKey aqui.
# Exibimos um aviso para rodar o comando manual depois.

- name: Aviso sobre Cadastro de Chaves
  ansible.builtin.debug:
    msg: 
      - "SUCESSO: Infraestrutura de segurança configurada."
      - "ATENÇÃO: Para cadastrar suas YubiKeys, execute este comando no terminal após o fim do playbook:"
      - "pamu2fcfg -n >> /etc/Yubico/u2f_mappings"
      - "Ou edite o arquivo manualmente no formato: usuario:KeyHandle...."
