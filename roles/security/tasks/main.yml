---
- name: Criar Serviço Systemd para Desbloqueio ZFS (Loop Infinito)
  ansible.builtin.copy:
    dest: /etc/systemd/system/zfs-load-key.service
    mode: '0644'
    content: |
      [Unit]
      Description=Load ZFS encryption keys (Persistent Loop)
      DefaultDependencies=no
      # Garante que os pools já foram escaneados/importados
      After=zfs-import.target
      Before=zfs-mount.service
      Requires=zfs-import.target

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      
      # Tenta garantir que o pool '{{ pool_name }}' está importado (ignora erro se já estiver)
      ExecStartPre=-/usr/sbin/zpool import -N {{ pool_name }}
      
      # O FIX CRÍTICO: Loop 'while' que não deixa o serviço morrer se a senha estiver errada.
      # Ele vai ficar pedindo "Senha incorreta. Tente novamente..." infinitamente.
      ExecStart=/bin/bash -c "while ! /usr/sbin/zfs load-key -a; do echo 'Senha incorreta ou Teclado/YubiKey não detectado. Tentando novamente em 1s...'; sleep 1; done"
      
      # Monta os discos assim que o loop acima tiver sucesso (exit code 0)
      ExecStartPost=/usr/sbin/zfs mount -a

      # Força o prompt a aparecer no monitor físico (Console)
      StandardInput=tty
      TTYPath=/dev/console
      StandardOutput=journal+console
      StandardError=journal+console
      
      # Desativa o timeout do Systemd (padrão é 90s) para esperar você digitar com calma
      TimeoutStartSec=0

      [Install]
      WantedBy=zfs-mount.service
  notify: Enable Boot Unlock

- name: Instalar pacotes de segurança
  ansible.builtin.apt:
    name:
      - sudo
      - libpam-u2f
      - libpam-pwquality
    state: present

- name: Configurar permissões de sudo para {{ new_user }}
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ new_user }}"
    content: "{{ new_user }} ALL=(ALL) ALL"
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Criar diretório Yubico
  ansible.builtin.file:
    path: /etc/Yubico
    state: directory
    mode: '0755'

- name: Garantir arquivo de mapeamento vazio (se não existir)
  ansible.builtin.file:
    path: /etc/Yubico/u2f_mappings
    state: touch
    mode: '0644'
    modification_time: preserve
    access_time: preserve

- name: Configurar PAM U2F (Auth)
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-auth
    line: "auth sufficient pam_u2f.so cue nouserok authfile=/etc/Yubico/u2f_mappings"
    insertbefore: BOF
    state: present

- name: Configurar Senhas Fortes
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-password
    line: "password requisite pam_pwquality.so retry=3 minlen=12 difok=4 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1 enforce_for_root"
    insertbefore: BOF
    state: present

- name: Aviso sobre Cadastro de Chaves
  ansible.builtin.debug:
    msg: 
      - "SUCESSO: Serviço de Boot corrigido e PAM configurado."
      - "ATENÇÃO: Cadastre suas chaves rodando manualmente: ./manual-yubikey-setup.sh"
