---
- name: Criar Servi√ßo Systemd para Desbloqueio ZFS (Clean UI)
  ansible.builtin.copy:
    dest: /etc/systemd/system/zfs-load-key.service
    mode: '0644'
    content: |
      [Unit]
      Description=Load ZFS encryption keys (Persistent Loop)
      DefaultDependencies=no
      After=zfs-import.target
      Before=zfs-mount.service
      Requires=zfs-import.target

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      
      # Tenta importar o pool se ainda n√£o estiver vis√≠vel
      ExecStartPre=-/usr/sbin/zpool import -N {{ pool_name }}
      
      # --- LOOP DE DESBLOQUEIO COM INTERFACE LIMPA ---
      # 1. Limpa a tela (reset terminal) para remover logs de boot.
      # 2. Exibe banner claro.
      # 3. Tenta carregar a chave. Se falhar, avisa e repete.
      ExecStart=/bin/bash -c "while true; do \
          printf '\033c'; \
          echo '============================================================='; \
          echo ' üîí  ZFS SECURITY: SISTEMA CRIPTOGRAFADO'; \
          echo '============================================================='; \
          echo ''; \
          echo 'Por favor, insira a senha para desbloquear o disco (PIN + YubiKey).'; \
          echo ''; \
          if /usr/sbin/zfs load-key -a; then \
              echo ''; \
              echo '‚úÖ Senha aceita! Continuando o boot...'; \
              break; \
          fi; \
          echo ''; \
          echo '‚ùå Senha Incorreta. Tentando novamente em 2 segundos...'; \
          sleep 2; \
      done"
      
      # Monta os discos imediatamente ap√≥s o sucesso
      ExecStartPost=/usr/sbin/zfs mount -a

      # Garante acesso exclusivo ao console f√≠sico
      StandardInput=tty
      TTYPath=/dev/console
      StandardOutput=journal+console
      StandardError=journal+console
      
      # Desativa timeout para esperar voc√™ digitar sem pressa
      TimeoutStartSec=0

      [Install]
      WantedBy=zfs-mount.service
  notify: Enable Boot Unlock

- name: Instalar pacotes de seguran√ßa e autentica√ß√£o
  ansible.builtin.apt:
    name:
      - sudo
      - libpam-u2f
      - libpam-pwquality
    state: present

- name: Configurar permiss√µes de sudo para {{ new_user }}
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ new_user }}"
    content: "{{ new_user }} ALL=(ALL) ALL"
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Criar diret√≥rio de configura√ß√£o Yubico
  ansible.builtin.file:
    path: /etc/Yubico
    state: directory
    mode: '0755'

- name: Garantir arquivo de mapeamento U2F vazio (se n√£o existir)
  ansible.builtin.file:
    path: /etc/Yubico/u2f_mappings
    state: touch
    mode: '0644'
    modification_time: preserve
    access_time: preserve

- name: Configurar PAM U2F (Auth) - Permitir login com Chave
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-auth
    line: "auth sufficient pam_u2f.so cue nouserok authfile=/etc/Yubico/u2f_mappings"
    insertbefore: BOF
    state: present

- name: Configurar PAM Password Quality (Senhas Fortes)
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-password
    line: "password requisite pam_pwquality.so retry=3 minlen=12 difok=4 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1 enforce_for_root"
    insertbefore: BOF
    state: present

- name: Aviso sobre Cadastro de Chaves YubiKey
  ansible.builtin.debug:
    msg: 
      - "SUCESSO: Servi√ßo de Boot com visual limpo configurado."
      - "ATEN√á√ÉO: Para cadastrar suas chaves, rode o script manual na raiz:"
      - "./manual-yubikey-setup.sh"
