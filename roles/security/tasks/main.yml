---
- name: Criar Serviço de Desbloqueio ZFS no Boot
  ansible.builtin.copy:
    dest: /etc/systemd/system/zfs-load-key.service
    mode: '0644'
    content: |
      [Unit]
      Description=Load ZFS encryption keys
      DefaultDependencies=no
      Before=zfs-mount.service
      After=zfs-import.target
      Requires=zfs-import.target
      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/usr/sbin/zfs load-key -a
      StandardInput=tty-force
      [Install]
      WantedBy=zfs-mount.service
  notify: Enable Boot Unlock

- name: Instalar Pacotes de Segurança
  ansible.builtin.apt:
    name: [sudo, libpam-u2f, libpam-pwquality]
    state: present

- name: Configurar Sudoers para {{ new_user }}
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ new_user }}"
    content: "{{ new_user }} ALL=(ALL) ALL"
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Criar diretório Yubico
  ansible.builtin.file:
    path: /etc/Yubico
    state: directory
    mode: '0755'

- name: Garantir arquivo de mapeamento vazio (se não existir)
  ansible.builtin.file:
    path: /etc/Yubico/u2f_mappings
    state: touch
    mode: '0644'

- name: Configurar PAM U2F (Auth)
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-auth
    line: "auth sufficient pam_u2f.so cue nouserok authfile=/etc/Yubico/u2f_mappings"
    insertbefore: BOF

- name: Configurar Senhas Fortes
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-password
    line: "password requisite pam_pwquality.so retry=3 minlen=12 difok=4 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1 enforce_for_root"
    insertbefore: BOF

- name: AVISO DE YUBIKEY
  ansible.builtin.debug:
    msg: 
      - "Atenção: A configuração do PAM foi aplicada."
      - "Para cadastrar suas chaves YubiKey, rode manualmente:"
      - "pamu2fcfg -n >> /etc/Yubico/u2f_mappings"
