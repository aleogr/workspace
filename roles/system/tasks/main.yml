---
# --- 1. LIMPEZA TOTAL (A Tática "Terra Arrasada") ---
# Em vez de tentar adivinhar o nome dos arquivos de erro, movemos tudo.

- name: Criar pasta de backup para repositórios antigos
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/backup_old
    state: directory
    mode: '0755'

- name: Mover TODAS as listas antigas para backup (Previne erro 401)
  ansible.builtin.shell: |
    mv /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/backup_old/ 2>/dev/null || true
    mv /etc/apt/sources.list.d/*.sources /etc/apt/sources.list.d/backup_old/ 2>/dev/null || true
  args:
    removes: /etc/apt/sources.list.d/ # Só roda se a pasta existir
  ignore_errors: true

- name: Esvaziar sources.list principal
  ansible.builtin.copy:
    dest: /etc/apt/sources.list
    content: "# Repositórios movidos para /etc/apt/sources.list.d/debian.sources\n"

# --- 2. RECONSTRUÇÃO (Arquivos Limpos) ---

- name: Criar Repositório Debian Base
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/debian.sources
    content: |
      Types: deb
      URIs: http://deb.debian.org/debian
      Suites: {{ debian_codename }} {{ debian_codename }}-updates
      Components: main contrib non-free non-free-firmware
      Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

      Types: deb
      URIs: http://security.debian.org/debian-security
      Suites: {{ debian_codename }}-security
      Components: main contrib non-free non-free-firmware
      Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

- name: Criar Repositório Proxmox No-Subscription
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/pve-no-subscription.sources
    content: |
      Types: deb
      URIs: http://download.proxmox.com/debian/pve
      Suites: {{ debian_codename }}
      Components: pve-no-subscription
      Signed-By: /usr/share/keyrings/proxmox-release-{{ debian_codename }}.gpg

      Types: deb
      URIs: http://download.proxmox.com/debian/pbs
      Suites: {{ debian_codename }}
      Components: pbs-no-subscription
      Signed-By: /usr/share/keyrings/proxmox-release-{{ debian_codename }}.gpg

      Types: deb
      URIs: http://download.proxmox.com/debian/ceph-squid
      Suites: {{ debian_codename }}
      Components: no-subscription
      Signed-By: /usr/share/keyrings/proxmox-release-{{ debian_codename }}.gpg

# --- 3. ATUALIZAÇÃO ---

- name: Atualizar Cache e Sistema (Dist-Upgrade)
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
    autoremove: yes

# --- 4. PACOTES E TWEAKS ---

- name: Instalar Pacotes Essenciais
  ansible.builtin.apt:
    name:
      - intel-microcode
      - build-essential
      - pve-headers
      - vim
      - htop
      - btop
      - curl
      - git
      - fastfetch
      - ethtool
      - net-tools
      - nvtop
    state: present

- name: Remover Aviso de Assinatura (Nag Removal)
  ansible.builtin.replace:
    path: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
    regexp: 'Ext\.Msg\.show\(\{\s+title: gettext\(''No valid subscription''\),'
    replace: "void({ //"
  notify: Restart PVEProxy
